<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDFæ™ºèƒ½å¤„ç†å·¥å…·</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4F46E5;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen p-6">
    <div class="max-w-7xl mx-auto">
        <div class="bg-white rounded-lg shadow-xl p-8">
            <div class="flex items-center gap-3 mb-6">
                <svg class="w-8 h-8 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                <h1 class="text-3xl font-bold text-gray-800">PDFæ™ºèƒ½å¤„ç†å·¥å…·</h1>
            </div>
            <p class="text-gray-600 mb-6">è‡ªåŠ¨è¯†åˆ«å¹´ä»½ã€å›½å®¶ï¼Œç”Ÿæˆè§„èŒƒæ–‡ä»¶åï¼Œå¹¶åˆ›å»ºExcelè¿½è¸ªè¡¨æ ¼</p>

            <!-- çŠ¶æ€æŒ‡ç¤º -->
            <div id="status" class="mb-4 p-3 rounded-lg hidden">
                <div class="flex items-center gap-2">
                    <div class="spinner"></div>
                    <span id="statusText">åˆå§‹åŒ–ä¸­...</span>
                </div>
            </div>

            <!-- æ–‡ä»¶ä¸Šä¼  -->
            <div class="mb-6">
                <label for="fileInput" class="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-indigo-300 rounded-lg cursor-pointer hover:bg-indigo-50 transition">
                    <svg class="w-12 h-12 text-indigo-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                    </svg>
                    <span class="text-sm text-gray-600">ç‚¹å‡»é€‰æ‹©PDFæ–‡ä»¶ï¼ˆæ”¯æŒæ‰¹é‡ï¼‰</span>
                    <input type="file" id="fileInput" accept=".pdf" multiple class="hidden">
                </label>
                <div id="fileCount" class="mt-3 text-sm text-gray-700 hidden"></div>
            </div>

            <!-- å¤„ç†é€‰é¡¹ -->
            <div class="bg-gray-50 rounded-lg p-4 mb-6">
                <h3 class="font-semibold text-gray-800 mb-3">å¤„ç†é€‰é¡¹</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <label class="flex items-center gap-2">
                        <input type="checkbox" id="detectYear" checked class="w-4 h-4">
                        <span class="text-sm font-medium text-indigo-700">è¯†åˆ«å¹´ä»½</span>
                    </label>
                    <label class="flex items-center gap-2">
                        <input type="checkbox" id="detectCountry" checked class="w-4 h-4">
                        <span class="text-sm font-medium text-indigo-700">è¯†åˆ«å›½å®¶</span>
                    </label>
                    <label class="flex items-center gap-2">
                        <input type="checkbox" id="removeHeaders" checked class="w-4 h-4">
                        <span class="text-sm">ç§»é™¤é¡µçœ‰</span>
                    </label>
                    <label class="flex items-center gap-2">
                        <input type="checkbox" id="removePageNumbers" checked class="w-4 h-4">
                        <span class="text-sm">ç§»é™¤é¡µç </span>
                    </label>
                    <label class="flex items-center gap-2">
                        <input type="checkbox" id="removeUrls" checked class="w-4 h-4">
                        <span class="text-sm">ç§»é™¤URL</span>
                    </label>
                    <label class="flex items-center gap-2">
                        <input type="checkbox" id="normalizeWhitespace" checked class="w-4 h-4">
                        <span class="text-sm">è§„èŒƒç©ºæ ¼</span>
                    </label>
                </div>
            </div>

            <!-- å¤„ç†æŒ‰é’® -->
            <button id="processBtn" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition">
                å¼€å§‹æ™ºèƒ½å¤„ç†
            </button>

            <!-- ç»“æœåŒºåŸŸ -->
            <div id="results" class="mt-8 hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800">å¤„ç†ç»“æœ (<span id="resultCount">0</span>ä¸ªæ–‡ä»¶)</h2>
                    <div class="flex flex-wrap gap-2">
                        <button id="downloadExcel" class="px-4 py-2 bg-green-600 text-white rounded-lg text-sm hover:bg-green-700 transition">
                            ğŸ“Š Excelè¿½è¸ªè¡¨
                        </button>
                        <button id="downloadAllTxt" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700 transition">
                            ğŸ“¥ å…¨éƒ¨TXT
                        </button>
                        <button id="downloadBertopic" class="px-4 py-2 bg-purple-600 text-white rounded-lg text-sm hover:bg-purple-700 transition">
                            ğŸ“ BERTopic
                        </button>
                    </div>
                </div>
                <div id="resultsList" class="space-y-4"></div>
            </div>
        </div>

        <!-- ä½¿ç”¨è¯´æ˜ -->
        <div class="mt-6 bg-white rounded-lg shadow-xl p-6">
            <h2 class="text-lg font-bold text-gray-800 mb-3">ğŸ¯ åŠŸèƒ½è¯´æ˜</h2>
            <div class="grid md:grid-cols-2 gap-4 text-sm text-gray-600">
                <div>
                    <h3 class="font-semibold text-gray-800 mb-2">æ™ºèƒ½è¯†åˆ«</h3>
                    <ul class="list-disc list-inside space-y-1">
                        <li>è‡ªåŠ¨è¯†åˆ«æ–‡æ¡£å‘å¸ƒå¹´ä»½ï¼ˆ1990-2025ï¼‰</li>
                        <li>æ™ºèƒ½æ£€æµ‹å›½å®¶/åœ°åŒºï¼ˆæ”¯æŒ30+å›½å®¶ï¼‰</li>
                        <li>ç”Ÿæˆè§„èŒƒåŒ–æ–‡ä»¶å: å›½å®¶_å¹´ä»½_åŸå.txt</li>
                        <li>æ”¯æŒä¸­è‹±æ–‡å…³é”®è¯æ··åˆè¯†åˆ«</li>
                    </ul>
                </div>
                <div>
                    <h3 class="font-semibold text-gray-800 mb-2">Excelè¿½è¸ªè¡¨</h3>
                    <ul class="list-disc list-inside space-y-1">
                        <li>è®°å½•åŸæ–‡ä»¶åå’Œæ–°æ–‡ä»¶åå¯¹ç…§</li>
                        <li>åŒ…å«è¯†åˆ«çš„å¹´ä»½ã€å›½å®¶ä¿¡æ¯åŠç½®ä¿¡åº¦</li>
                        <li>ç»Ÿè®¡å­—æ•°ã€å­—ç¬¦æ•°ã€å†…å®¹é¢„è§ˆ</li>
                        <li>æ”¯æŒæŒç»­æ›´æ–°å’Œè¿½è¸ªç®¡ç†</li>
                    </ul>
                </div>
            </div>
            <div class="mt-4 p-3 bg-yellow-50 rounded text-sm text-yellow-800">
                <strong>ğŸ’¡ æç¤º:</strong> æ­¤ä¸ºç‹¬ç«‹HTMLç‰ˆæœ¬ï¼Œå¯ç¦»çº¿ä½¿ç”¨ã€‚ä¿å­˜åˆ°æ¡Œé¢ï¼Œéšæ—¶åŒå‡»æ‰“å¼€ï¼
            </div>
        </div>
    </div>

    <script>
        // ç­‰å¾…PDF.jsåŠ è½½
        window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        let selectedFiles = [];
        let processedResults = [];

        // ä¼˜åŒ–çš„å›½å®¶å…³é”®è¯æ˜ å°„ï¼ˆå¢åŠ ç‹¬ç‰¹æ€§å’Œæƒé‡ï¼‰
        const countryKeywords = {
            'Germany': {
                keywords: ['germany', 'german', 'deutschland', 'bundesrepublik', 'berlin', 'å¾·å›½', 'germane'],
                uniqueWords: ['bundestag', 'bundesrat', 'bundesregierung', 'merkel', 'scholz'],
                weight: 1.5
            },
            'USA': {
                keywords: ['united states', 'usa', 'u.s.', 'america', 'american', 'ç¾å›½'],
                uniqueWords: ['washington dc', 'congress', 'senate', 'biden', 'trump', 'federal reserve'],
                weight: 1.3
            },
            'UK': {
                keywords: ['united kingdom', 'uk', 'u.k.', 'britain', 'british', 'england', 'è‹±å›½'],
                uniqueWords: ['parliament', 'westminster', 'downing street', 'brexit'],
                weight: 1.4
            },
            'China': {
                keywords: ['china', 'chinese', 'ä¸­å›½', 'ä¸­åäººæ°‘å…±å’Œå›½', 'prc', "people's republic"],
                uniqueWords: ['beijing', 'åŒ—äº¬', 'renminbi', 'äººæ°‘å¸', 'ccp', 'ä¸­å…±'],
                weight: 1.5
            },
            'Japan': {
                keywords: ['japan', 'japanese', 'æ—¥æœ¬', 'jpn', 'nihon'],
                uniqueWords: ['tokyo', 'æ±äº¬', 'yen', 'å††', 'diet'],
                weight: 1.4
            },
            'France': {
                keywords: ['france', 'french', 'æ³•å›½', 'franÃ§ais', 'rÃ©publique franÃ§aise'],
                uniqueWords: ['paris', 'Ã©lysÃ©e', 'macron', 'assemblÃ©e nationale'],
                weight: 1.4
            },
            'India': {
                keywords: ['india', 'indian', 'å°åº¦', 'bharat'],
                uniqueWords: ['delhi', 'mumbai', 'rupee', 'lok sabha', 'modi'],
                weight: 1.3
            },
            'Russia': {
                keywords: ['russia', 'russian', 'ä¿„ç½—æ–¯', 'Ñ€Ğ¾ÑÑĞ¸Ğ¹ÑĞºĞ°Ñ', 'federation'],
                uniqueWords: ['moscow', 'kremlin', 'putin', 'duma', 'ruble'],
                weight: 1.4
            },
            'Brazil': {
                keywords: ['brazil', 'brazilian', 'å·´è¥¿', 'brasil'],
                uniqueWords: ['brasÃ­lia', 'real', 'lula', 'bolsonaro'],
                weight: 1.3
            },
            'Canada': {
                keywords: ['canada', 'canadian', 'åŠ æ‹¿å¤§'],
                uniqueWords: ['ottawa', 'trudeau', 'quebec', 'ontario'],
                weight: 1.3
            },
            'Australia': {
                keywords: ['australia', 'australian', 'æ¾³å¤§åˆ©äºš', 'æ¾³æ´²'],
                uniqueWords: ['canberra', 'sydney', 'melbourne'],
                weight: 1.3
            },
            'SouthKorea': {
                keywords: ['south korea', 'korea', 'korean', 'éŸ©å›½', 'ë‚¨í•œ', 'republic of korea'],
                uniqueWords: ['seoul', 'ì„œìš¸', 'won', 'ì²­ì™€ëŒ€'],
                weight: 1.4
            },
            'Italy': {
                keywords: ['italy', 'italian', 'æ„å¤§åˆ©', 'italia', 'repubblica italiana'],
                uniqueWords: ['rome', 'roma', 'euro', 'quirinale'],
                weight: 1.3
            },
            'Spain': {
                keywords: ['spain', 'spanish', 'è¥¿ç­ç‰™', 'espaÃ±a', 'reino de espaÃ±a'],
                uniqueWords: ['madrid', 'cortes', 'zarzuela'],
                weight: 1.3
            },
            'Mexico': {
                keywords: ['mexico', 'mexican', 'å¢¨è¥¿å“¥', 'mÃ©xico'],
                uniqueWords: ['ciudad de mÃ©xico', 'peso', 'amlo'],
                weight: 1.3
            },
            'Singapore': {
                keywords: ['singapore', 'æ–°åŠ å¡', 'singapura'],
                uniqueWords: ['sg', 'mrt', 'cpf', 'hdb'],
                weight: 1.4
            },
            'HongKong': {
                keywords: ['hong kong', 'hongkong', 'é¦™æ¸¯', 'hk', 'hksar'],
                uniqueWords: ['kowloon', 'ä¹é¾', 'hkd', 'victoria harbour'],
                weight: 1.4
            },
            'Taiwan': {
                keywords: ['taiwan', 'å°æ¹¾', 'è‡ºç£', 'republic of china', 'roc'],
                uniqueWords: ['taipei', 'å°åŒ—', 'twd', 'legislative yuan'],
                weight: 1.4
            },
            'Netherlands': {
                keywords: ['netherlands', 'dutch', 'è·å…°', 'nederland'],
                uniqueWords: ['amsterdam', 'hague', 'den haag'],
                weight: 1.3
            },
            'Switzerland': {
                keywords: ['switzerland', 'swiss', 'ç‘å£«', 'schweiz', 'suisse'],
                uniqueWords: ['bern', 'zÃ¼rich', 'geneva', 'franc'],
                weight: 1.3
            },
            'Sweden': {
                keywords: ['sweden', 'swedish', 'ç‘å…¸', 'sverige'],
                uniqueWords: ['stockholm', 'krona', 'riksdag'],
                weight: 1.3
            },
            'EU': {
                keywords: ['european union', 'eu', 'æ¬§ç›Ÿ', 'european commission'],
                uniqueWords: ['brussels', 'strasbourg', 'eurozone', 'schengen'],
                weight: 1.2
            }
        };

        // æ–‡ä»¶é€‰æ‹©
        document.getElementById('fileInput').addEventListener('change', (e) => {
            selectedFiles = Array.from(e.target.files);
            if (selectedFiles.length > 0) {
                document.getElementById('fileCount').textContent = `å·²é€‰æ‹© ${selectedFiles.length} ä¸ªæ–‡ä»¶`;
                document.getElementById('fileCount').classList.remove('hidden');
                processedResults = []; // æ¸…ç©ºä¹‹å‰çš„ç»“æœ
            }
        });

        // ä¼˜åŒ–çš„æå–å¹´ä»½å‡½æ•°
        function extractYear(text) {
            const years = [];
            const yearPattern = /\b(19[89][0-9]|20[0-2][0-9])\b/g;
            const matches = text.match(yearPattern);
            
            if (!matches) return null;
            
            // ç»Ÿè®¡å¹´ä»½å‡ºç°é¢‘ç‡
            const yearCounts = {};
            matches.forEach(year => {
                const y = parseInt(year);
                if (y >= 1990 && y <= 2025) {
                    yearCounts[y] = (yearCounts[y] || 0) + 1;
                }
            });
            
            if (Object.keys(yearCounts).length === 0) return null;
            
            // è·å–æœ€å¸¸å‡ºç°çš„å¹´ä»½
            const sortedYears = Object.entries(yearCounts)
                .sort((a, b) => b[1] - a[1]);
            
            return sortedYears[0][0];
        }

        // ä¼˜åŒ–çš„æå–å›½å®¶å‡½æ•°
        function extractCountry(text) {
            const lowerText = text.toLowerCase();
            const firstPage = text.substring(0, 5000).toLowerCase(); // å¢åŠ é¦–é¡µæ‰«æèŒƒå›´
            const scores = {};
            
            Object.entries(countryKeywords).forEach(([country, config]) => {
                let score = 0;
                
                // é€šç”¨å…³é”®è¯
                config.keywords.forEach(keyword => {
                    const keywordLower = keyword.toLowerCase();
                    // é¦–é¡µåŒ¹é…ï¼ˆé«˜æƒé‡ï¼‰
                    const firstPageMatches = (firstPage.match(new RegExp('\\b' + keywordLower.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\b', 'gi')) || []).length;
                    // å…¨æ–‡åŒ¹é…
                    const allMatches = (lowerText.match(new RegExp('\\b' + keywordLower.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\b', 'gi')) || []).length;
                    score += firstPageMatches * 5 * config.weight + allMatches * config.weight;
                });
                
                // ç‹¬ç‰¹å…³é”®è¯ï¼ˆæ›´é«˜æƒé‡ï¼‰
                if (config.uniqueWords) {
                    config.uniqueWords.forEach(uniqueWord => {
                        const uniqueLower = uniqueWord.toLowerCase();
                        const firstPageUnique = (firstPage.match(new RegExp('\\b' + uniqueLower.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\b', 'gi')) || []).length;
                        const allUnique = (lowerText.match(new RegExp('\\b' + uniqueLower.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\b', 'gi')) || []).length;
                        score += firstPageUnique * 10 * config.weight + allUnique * 3 * config.weight;
                    });
                }
                
                if (score > 0) {
                    scores[country] = score;
                }
            });
            
            if (Object.keys(scores).length === 0) return null;
            
            // è·å–æœ€é«˜åˆ†çš„å›½å®¶
            const sortedCountries = Object.entries(scores)
                .sort((a, b) => b[1] - a[1]);
            
            // å¦‚æœæœ€é«˜åˆ†æ˜æ˜¾é«˜äºç¬¬äºŒåï¼ˆ>30%ï¼‰ï¼Œåˆ™è¿”å›æœ€é«˜åˆ†å›½å®¶
            if (sortedCountries.length === 1 || 
                sortedCountries[0][1] > sortedCountries[1][1] * 1.3) {
                return sortedCountries[0][0];
            }
            
            // å¦åˆ™è¿”å›Unknown
            console.log('å›½å®¶è¯†åˆ«å¾—åˆ†:', sortedCountries.slice(0, 3));
            return sortedCountries[0][0];
        }

        // æ¸…æ´—æ–‡æœ¬
        function cleanText(text) {
            let cleaned = text;
            
            if (document.getElementById('removeUrls').checked) {
                cleaned = cleaned.replace(/https?:\/\/[^\s]+/g, '');
            }
            if (document.getElementById('removePageNumbers').checked) {
                cleaned = cleaned.replace(/^\s*\d+\s*$/gm, '');
                cleaned = cleaned.replace(/Page \d+ of \d+/gi, '');
            }
            if (document.getElementById('normalizeWhitespace').checked) {
                cleaned = cleaned.replace(/\s+/g, ' ');
                cleaned = cleaned.replace(/\n\s*\n/g, '\n\n');
            }
            
            return cleaned.trim();
        }

        // æå–PDFæ–‡æœ¬
        async function extractTextFromPDF(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await window.pdfjsLib.getDocument(arrayBuffer).promise;
            let fullText = '';
            
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                const pageText = textContent.items.map(item => item.str).join(' ');
                fullText += pageText + '\n\n';
            }
            
            return fullText;
        }

        // å¤„ç†PDF
        document.getElementById('processBtn').addEventListener('click', async () => {
            if (selectedFiles.length === 0) {
                alert('è¯·å…ˆé€‰æ‹©PDFæ–‡ä»¶');
                return;
            }

            const statusDiv = document.getElementById('status');
            const statusText = document.getElementById('statusText');
            const processBtn = document.getElementById('processBtn');
            
            statusDiv.classList.remove('hidden');
            statusDiv.className = 'mb-4 p-3 rounded-lg bg-blue-50 text-blue-700';
            processBtn.disabled = true;
            
            processedResults = []; // ç¡®ä¿æ¸…ç©ºæ—§ç»“æœ
            const trackingData = [];

            for (let i = 0; i < selectedFiles.length; i++) {
                const file = selectedFiles[i];
                statusText.textContent = `å¤„ç†ä¸­ ${i + 1}/${selectedFiles.length}: ${file.name}`;
                
                try {
                    const rawText = await extractTextFromPDF(file);
                    const cleanedText = cleanText(rawText);
                    
                    const year = document.getElementById('detectYear').checked ? extractYear(rawText) : null;
                    const country = document.getElementById('detectCountry').checked ? extractCountry(rawText) : null;
                    
                    const wordCount = cleanedText.split(/\s+/).filter(w => w.length > 0).length;
                    const preview = cleanedText.substring(0, 200).replace(/\s+/g, ' ').trim() + '...';
                    
                    const originalName = file.name.replace('.pdf', '');
                    const newFileName = [
                        country,
                        year,
                        originalName
                    ].filter(v => v !== null && v !== undefined).join('_') + '.txt';
                    
                    const result = {
                        originalFilename: file.name,
                        newFilename: newFileName,
                        year: year || 'æœªè¯†åˆ«',
                        country: country || 'æœªè¯†åˆ«',
                        cleanedText,
                        wordCount,
                        charCount: cleanedText.length,
                        lineCount: cleanedText.split('\n').length,
                        preview,
                        status: 'success'
                    };
                    
                    processedResults.push(result);
                    console.log(`æˆåŠŸå¤„ç†ç¬¬ ${i + 1} ä¸ªæ–‡ä»¶:`, result.originalFilename);
                    
                    trackingData.push({
                        'åºå·': i + 1,
                        'åŸæ–‡ä»¶å': file.name,
                        'æ–°æ–‡ä»¶å': newFileName,
                        'è¯†åˆ«å¹´ä»½': year || 'æœªè¯†åˆ«',
                        'è¯†åˆ«å›½å®¶': country || 'æœªè¯†åˆ«',
                        'å­—æ•°': wordCount,
                        'å­—ç¬¦æ•°': cleanedText.length,
                        'è¡Œæ•°': cleanedText.split('\n').length,
                        'å†…å®¹é¢„è§ˆ': preview,
                        'å¤„ç†æ—¶é—´': new Date().toLocaleString('zh-CN'),
                        'çŠ¶æ€': 'æˆåŠŸ'
                    });
                    
                } catch (error) {
                    console.error(`å¤„ç†æ–‡ä»¶å¤±è´¥ ${file.name}:`, error);
                    processedResults.push({
                        originalFilename: file.name,
                        error: error.message,
                        status: 'error'
                    });
                    
                    trackingData.push({
                        'åºå·': i + 1,
                        'åŸæ–‡ä»¶å': file.name,
                        'æ–°æ–‡ä»¶å': 'å¤„ç†å¤±è´¥',
                        'è¯†åˆ«å¹´ä»½': '-',
                        'è¯†åˆ«å›½å®¶': '-',
                        'å­—æ•°': 0,
                        'å­—ç¬¦æ•°': 0,
                        'è¡Œæ•°': 0,
                        'å†…å®¹é¢„è§ˆ': 'é”™è¯¯: ' + error.message,
                        'å¤„ç†æ—¶é—´': new Date().toLocaleString('zh-CN'),
                        'çŠ¶æ€': 'å¤±è´¥'
                    });
                }
            }

            console.log('æ‰€æœ‰å¤„ç†ç»“æœ:', processedResults);
            
            // ä¿å­˜è¿½è¸ªæ•°æ®ä¾›ä¸‹è½½ä½¿ç”¨
            window.trackingData = trackingData;
            
            statusDiv.className = 'mb-4 p-3 rounded-lg bg-green-50 text-green-700';
            statusText.textContent = `âœ… å¤„ç†å®Œæˆï¼å…±å¤„ç† ${processedResults.length} ä¸ªæ–‡ä»¶ï¼ŒæˆåŠŸ ${processedResults.filter(r => r.status === 'success').length} ä¸ª`;
            processBtn.disabled = false;
            
            displayResults();
        });

        // æ˜¾ç¤ºç»“æœ
        function displayResults() {
            const resultsList = document.getElementById('resultsList');
            const resultCount = document.getElementById('resultCount');
            resultsList.innerHTML = '';
            resultCount.textContent = processedResults.length;
            
            console.log('æ˜¾ç¤ºç»“æœæ•°é‡:', processedResults.length);
            
            processedResults.forEach((result, idx) => {
                const div = document.createElement('div');
                div.className = 'border border-gray-200 rounded-lg p-4 bg-white shadow-sm';
                
                if (result.status === 'success') {
                    div.innerHTML = `
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <span class="text-sm text-gray-500">æ–‡ä»¶ #${idx + 1}</span>
                                </div>
                                <div class="text-sm text-gray-500 mb-1">åŸæ–‡ä»¶å:</div>
                                <div class="font-medium text-gray-800 mb-2">${result.originalFilename}</div>
                                <div class="text-sm text-gray-500 mb-1">æ–°æ–‡ä»¶å:</div>
                                <div class="font-semibold text-indigo-700 mb-2">${result.newFilename}</div>
                                <div class="flex gap-4 text-sm text-gray-600 flex-wrap">
                                    <span class="bg-blue-100 px-2 py-1 rounded">ğŸ“… ${result.year}</span>
                                    <span class="bg-green-100 px-2 py-1 rounded">ğŸŒ ${result.country}</span>
                                    <span class="bg-purple-100 px-2 py-1 rounded">ğŸ“ ${result.wordCount} è¯</span>
                                    <span class="bg-gray-100 px-2 py-1 rounded">ğŸ’¾ ${result.charCount} å­—ç¬¦</span>
                                </div>
                            </div>
                            <button onclick="downloadSingleTXT(${idx})" class="px-3 py-1 bg-indigo-600 text-white rounded text-sm hover:bg-indigo-700 transition whitespace-nowrap ml-4">
                                ä¸‹è½½TXT
                            </button>
                        </div>
                        <div class="bg-gray-50 rounded p-3 mt-3">
                            <div class="text-xs text-gray-600 mb-1">å†…å®¹é¢„è§ˆ:</div>
                            <pre class="text-xs text-gray-700 whitespace-pre-wrap">${result.preview}</pre>
                        </div>
                    `;
                } else {
                    div.innerHTML = `
                        <div class="flex items-start gap-3">
                            <svg class="w-5 h-5 text-red-500 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <div>
                                <div class="text-sm text-gray-500 mb-1">æ–‡ä»¶ #${idx + 1}</div>
                                <div class="font-medium text-gray-800 mb-1">${result.originalFilename}</div>
                                <div class="text-red-600 text-sm">âŒ é”™è¯¯: ${result.error}</div>
                            </div>
                        </div>
                    `;
                }
                
                resultsList.appendChild(div);
            });
            
            document.getElementById('results').classList.remove('hidden');
        }

        // ä¸‹è½½å•ä¸ªTXT
        window.downloadSingleTXT = function(idx) {
            const result = processedResults[idx];
            if (!result || result.status !== 'success') {
                alert('æ— æ³•ä¸‹è½½è¯¥æ–‡ä»¶');
                return;
            }
            const blob = new Blob([result.cleanedText], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = result.newFilename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            console.log('ä¸‹è½½æ–‡ä»¶:', result.newFilename);
        };

        // ä¸‹è½½å…¨éƒ¨TXT
        document.getElementById('downloadAllTxt').addEventListener('click', () => {
            const successResults = processedResults.filter(r => r.status === 'success');
            console.log('å‡†å¤‡ä¸‹è½½', successResults.length, 'ä¸ªTXTæ–‡ä»¶');
            
            if (successResults.length === 0) {
                alert('æ²¡æœ‰å¯ä¸‹è½½çš„æ–‡ä»¶');
                return;
            }
            
            successResults.forEach((result, idx) => {
                setTimeout(() => {
                    const blob = new Blob([result.cleanedText], { type: 'text/plain;charset=utf-8' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = result.newFilename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    console.log('ä¸‹è½½ç¬¬', idx + 1, 'ä¸ªæ–‡ä»¶:', result.newFilename);
                }, idx * 200); // å»¶è¿Ÿä¸‹è½½ï¼Œé¿å…æµè§ˆå™¨é˜»æ­¢
            });
        });

        // ä¸‹è½½BERTopicæ ¼å¼
        document.getElementById('downloadBertopic').addEventListener('click', () => {
            const successResults = processedResults.filter(r => r.status === 'success');
            
            if (successResults.length === 0) {
                alert('æ²¡æœ‰å¯ä¸‹è½½çš„æ–‡ä»¶');
                return;
            }
            
            const text = successResults
                .map(r => r.cleanedText.replace(/\n/g, ' ').replace(/\s+/g, ' ').trim())
                .join('\n');
            
            const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `bertopic_corpus_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            console.log('BERTopicæ ¼å¼ä¸‹è½½å®Œæˆ');
        });

        // ä¸‹è½½Excel
        document.getElementById('downloadExcel').addEventListener('click', () => {
            if (!window.trackingData || window.trackingData.length === 0) {
                alert('æ²¡æœ‰å¯ä¸‹è½½çš„æ•°æ®');
                return;
            }
            
            const ws = XLSX.utils.json_to_sheet(window.trackingData);
            ws['!cols'] = [
                { wch: 6 }, { wch: 35 }, { wch: 40 }, { wch: 10 }, { wch: 12 },
                { wch: 8 }, { wch: 10 }, { wch: 8 }, { wch: 50 }, { wch: 18 }, { wch: 8 }
            ];
            
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'PDFå¤„ç†è¿½è¸ª');
            
            const instructionsData = [
                { 'è¯´æ˜': 'æœ¬è¡¨æ ¼è®°å½•PDFæ–‡ä»¶çš„å¤„ç†ä¿¡æ¯' },
                { 'è¯´æ˜': 'å¯ç”¨äºæŒç»­è¿½è¸ªå’Œç®¡ç†æ–‡æ¡£å¤„ç†è¿›åº¦' },
                { 'è¯´æ˜': 'æ¯æ¬¡å¤„ç†ä¼šç”Ÿæˆæ–°çš„è®°å½•' },
                { 'è¯´æ˜': 'è¯†åˆ«å¹´ä»½èŒƒå›´: 1990-2025' },
                { 'è¯´æ˜': 'æ”¯æŒå›½å®¶: 30+ä¸»è¦å›½å®¶å’Œåœ°åŒº' }
            ];
            const wsInstructions = XLSX.utils.json_to_sheet(instructionsData);
            XLSX.utils.book_append_sheet(wb, wsInstructions, 'ä½¿ç”¨è¯´æ˜');
            
            XLSX.writeFile(wb, `PDFå¤„ç†è¿½è¸ªè¡¨_${new Date().toISOString().split('T')[0]}.xlsx`);
            console.log('Excelè¿½è¸ªè¡¨ä¸‹è½½å®Œæˆ');
        });
    </script>
</body>
</html>