<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF智能处理工具</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4F46E5;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen p-6">
    <div class="max-w-7xl mx-auto">
        <div class="bg-white rounded-lg shadow-xl p-8">
            <div class="flex items-center gap-3 mb-6">
                <svg class="w-8 h-8 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                <h1 class="text-3xl font-bold text-gray-800">PDF智能处理工具</h1>
            </div>
            <p class="text-gray-600 mb-6">自动识别年份、国家，生成规范文件名，并创建Excel追踪表格</p>

            <!-- 状态指示 -->
            <div id="status" class="mb-4 p-3 rounded-lg hidden">
                <div class="flex items-center gap-2">
                    <div class="spinner"></div>
                    <span id="statusText">初始化中...</span>
                </div>
            </div>

            <!-- 文件上传 -->
            <div class="mb-6">
                <label for="fileInput" class="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-indigo-300 rounded-lg cursor-pointer hover:bg-indigo-50 transition">
                    <svg class="w-12 h-12 text-indigo-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                    </svg>
                    <span class="text-sm text-gray-600">点击选择PDF文件（支持批量）</span>
                    <input type="file" id="fileInput" accept=".pdf" multiple class="hidden">
                </label>
                <div id="fileCount" class="mt-3 text-sm text-gray-700 hidden"></div>
            </div>

            <!-- 处理选项 -->
            <div class="bg-gray-50 rounded-lg p-4 mb-6">
                <h3 class="font-semibold text-gray-800 mb-3">处理选项</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <label class="flex items-center gap-2">
                        <input type="checkbox" id="detectYear" checked class="w-4 h-4">
                        <span class="text-sm font-medium text-indigo-700">识别年份</span>
                    </label>
                    <label class="flex items-center gap-2">
                        <input type="checkbox" id="detectCountry" checked class="w-4 h-4">
                        <span class="text-sm font-medium text-indigo-700">识别国家</span>
                    </label>
                    <label class="flex items-center gap-2">
                        <input type="checkbox" id="removeHeaders" checked class="w-4 h-4">
                        <span class="text-sm">移除页眉</span>
                    </label>
                    <label class="flex items-center gap-2">
                        <input type="checkbox" id="removePageNumbers" checked class="w-4 h-4">
                        <span class="text-sm">移除页码</span>
                    </label>
                    <label class="flex items-center gap-2">
                        <input type="checkbox" id="removeUrls" checked class="w-4 h-4">
                        <span class="text-sm">移除URL</span>
                    </label>
                    <label class="flex items-center gap-2">
                        <input type="checkbox" id="normalizeWhitespace" checked class="w-4 h-4">
                        <span class="text-sm">规范空格</span>
                    </label>
                </div>
            </div>

            <!-- 处理按钮 -->
            <button id="processBtn" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition">
                开始智能处理
            </button>

            <!-- 结果区域 -->
            <div id="results" class="mt-8 hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800">处理结果 (<span id="resultCount">0</span>个文件)</h2>
                    <div class="flex flex-wrap gap-2">
                        <button id="downloadExcel" class="px-4 py-2 bg-green-600 text-white rounded-lg text-sm hover:bg-green-700 transition">
                            📊 Excel追踪表
                        </button>
                        <button id="downloadAllTxt" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700 transition">
                            📥 全部TXT
                        </button>
                        <button id="downloadBertopic" class="px-4 py-2 bg-purple-600 text-white rounded-lg text-sm hover:bg-purple-700 transition">
                            📝 BERTopic
                        </button>
                    </div>
                </div>
                <div id="resultsList" class="space-y-4"></div>
            </div>
        </div>

        <!-- 使用说明 -->
        <div class="mt-6 bg-white rounded-lg shadow-xl p-6">
            <h2 class="text-lg font-bold text-gray-800 mb-3">🎯 功能说明</h2>
            <div class="grid md:grid-cols-2 gap-4 text-sm text-gray-600">
                <div>
                    <h3 class="font-semibold text-gray-800 mb-2">智能识别</h3>
                    <ul class="list-disc list-inside space-y-1">
                        <li>自动识别文档发布年份（1990-2025）</li>
                        <li>智能检测国家/地区（支持30+国家）</li>
                        <li>生成规范化文件名: 国家_年份_原名.txt</li>
                        <li>支持中英文关键词混合识别</li>
                    </ul>
                </div>
                <div>
                    <h3 class="font-semibold text-gray-800 mb-2">Excel追踪表</h3>
                    <ul class="list-disc list-inside space-y-1">
                        <li>记录原文件名和新文件名对照</li>
                        <li>包含识别的年份、国家信息及置信度</li>
                        <li>统计字数、字符数、内容预览</li>
                        <li>支持持续更新和追踪管理</li>
                    </ul>
                </div>
            </div>
            <div class="mt-4 p-3 bg-yellow-50 rounded text-sm text-yellow-800">
                <strong>💡 提示:</strong> 此为独立HTML版本，可离线使用。保存到桌面，随时双击打开！
            </div>
        </div>
    </div>

    <script>
        // 等待PDF.js加载
        window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        let selectedFiles = [];
        let processedResults = [];

        // 优化的国家关键词映射（增加独特性和权重）
        const countryKeywords = {
            'Germany': {
                keywords: ['germany', 'german', 'deutschland', 'bundesrepublik', 'berlin', '德国', 'germane'],
                uniqueWords: ['bundestag', 'bundesrat', 'bundesregierung', 'merkel', 'scholz'],
                weight: 1.5
            },
            'USA': {
                keywords: ['united states', 'usa', 'u.s.', 'america', 'american', '美国'],
                uniqueWords: ['washington dc', 'congress', 'senate', 'biden', 'trump', 'federal reserve'],
                weight: 1.3
            },
            'UK': {
                keywords: ['united kingdom', 'uk', 'u.k.', 'britain', 'british', 'england', '英国'],
                uniqueWords: ['parliament', 'westminster', 'downing street', 'brexit'],
                weight: 1.4
            },
            'China': {
                keywords: ['china', 'chinese', '中国', '中华人民共和国', 'prc', "people's republic"],
                uniqueWords: ['beijing', '北京', 'renminbi', '人民币', 'ccp', '中共'],
                weight: 1.5
            },
            'Japan': {
                keywords: ['japan', 'japanese', '日本', 'jpn', 'nihon'],
                uniqueWords: ['tokyo', '東京', 'yen', '円', 'diet'],
                weight: 1.4
            },
            'France': {
                keywords: ['france', 'french', '法国', 'français', 'république française'],
                uniqueWords: ['paris', 'élysée', 'macron', 'assemblée nationale'],
                weight: 1.4
            },
            'India': {
                keywords: ['india', 'indian', '印度', 'bharat'],
                uniqueWords: ['delhi', 'mumbai', 'rupee', 'lok sabha', 'modi'],
                weight: 1.3
            },
            'Russia': {
                keywords: ['russia', 'russian', '俄罗斯', 'российская', 'federation'],
                uniqueWords: ['moscow', 'kremlin', 'putin', 'duma', 'ruble'],
                weight: 1.4
            },
            'Brazil': {
                keywords: ['brazil', 'brazilian', '巴西', 'brasil'],
                uniqueWords: ['brasília', 'real', 'lula', 'bolsonaro'],
                weight: 1.3
            },
            'Canada': {
                keywords: ['canada', 'canadian', '加拿大'],
                uniqueWords: ['ottawa', 'trudeau', 'quebec', 'ontario'],
                weight: 1.3
            },
            'Australia': {
                keywords: ['australia', 'australian', '澳大利亚', '澳洲'],
                uniqueWords: ['canberra', 'sydney', 'melbourne'],
                weight: 1.3
            },
            'SouthKorea': {
                keywords: ['south korea', 'korea', 'korean', '韩国', '남한', 'republic of korea'],
                uniqueWords: ['seoul', '서울', 'won', '청와대'],
                weight: 1.4
            },
            'Italy': {
                keywords: ['italy', 'italian', '意大利', 'italia', 'repubblica italiana'],
                uniqueWords: ['rome', 'roma', 'euro', 'quirinale'],
                weight: 1.3
            },
            'Spain': {
                keywords: ['spain', 'spanish', '西班牙', 'españa', 'reino de españa'],
                uniqueWords: ['madrid', 'cortes', 'zarzuela'],
                weight: 1.3
            },
            'Mexico': {
                keywords: ['mexico', 'mexican', '墨西哥', 'méxico'],
                uniqueWords: ['ciudad de méxico', 'peso', 'amlo'],
                weight: 1.3
            },
            'Singapore': {
                keywords: ['singapore', '新加坡', 'singapura'],
                uniqueWords: ['sg', 'mrt', 'cpf', 'hdb'],
                weight: 1.4
            },
            'HongKong': {
                keywords: ['hong kong', 'hongkong', '香港', 'hk', 'hksar'],
                uniqueWords: ['kowloon', '九龍', 'hkd', 'victoria harbour'],
                weight: 1.4
            },
            'Taiwan': {
                keywords: ['taiwan', '台湾', '臺灣', 'republic of china', 'roc'],
                uniqueWords: ['taipei', '台北', 'twd', 'legislative yuan'],
                weight: 1.4
            },
            'Netherlands': {
                keywords: ['netherlands', 'dutch', '荷兰', 'nederland'],
                uniqueWords: ['amsterdam', 'hague', 'den haag'],
                weight: 1.3
            },
            'Switzerland': {
                keywords: ['switzerland', 'swiss', '瑞士', 'schweiz', 'suisse'],
                uniqueWords: ['bern', 'zürich', 'geneva', 'franc'],
                weight: 1.3
            },
            'Sweden': {
                keywords: ['sweden', 'swedish', '瑞典', 'sverige'],
                uniqueWords: ['stockholm', 'krona', 'riksdag'],
                weight: 1.3
            },
            'EU': {
                keywords: ['european union', 'eu', '欧盟', 'european commission'],
                uniqueWords: ['brussels', 'strasbourg', 'eurozone', 'schengen'],
                weight: 1.2
            }
        };

        // 文件选择
        document.getElementById('fileInput').addEventListener('change', (e) => {
            selectedFiles = Array.from(e.target.files);
            if (selectedFiles.length > 0) {
                document.getElementById('fileCount').textContent = `已选择 ${selectedFiles.length} 个文件`;
                document.getElementById('fileCount').classList.remove('hidden');
                processedResults = []; // 清空之前的结果
            }
        });

        // 优化的提取年份函数
        function extractYear(text) {
            const years = [];
            const yearPattern = /\b(19[89][0-9]|20[0-2][0-9])\b/g;
            const matches = text.match(yearPattern);
            
            if (!matches) return null;
            
            // 统计年份出现频率
            const yearCounts = {};
            matches.forEach(year => {
                const y = parseInt(year);
                if (y >= 1990 && y <= 2025) {
                    yearCounts[y] = (yearCounts[y] || 0) + 1;
                }
            });
            
            if (Object.keys(yearCounts).length === 0) return null;
            
            // 获取最常出现的年份
            const sortedYears = Object.entries(yearCounts)
                .sort((a, b) => b[1] - a[1]);
            
            return sortedYears[0][0];
        }

        // 优化的提取国家函数
        function extractCountry(text) {
            const lowerText = text.toLowerCase();
            const firstPage = text.substring(0, 5000).toLowerCase(); // 增加首页扫描范围
            const scores = {};
            
            Object.entries(countryKeywords).forEach(([country, config]) => {
                let score = 0;
                
                // 通用关键词
                config.keywords.forEach(keyword => {
                    const keywordLower = keyword.toLowerCase();
                    // 首页匹配（高权重）
                    const firstPageMatches = (firstPage.match(new RegExp('\\b' + keywordLower.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\b', 'gi')) || []).length;
                    // 全文匹配
                    const allMatches = (lowerText.match(new RegExp('\\b' + keywordLower.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\b', 'gi')) || []).length;
                    score += firstPageMatches * 5 * config.weight + allMatches * config.weight;
                });
                
                // 独特关键词（更高权重）
                if (config.uniqueWords) {
                    config.uniqueWords.forEach(uniqueWord => {
                        const uniqueLower = uniqueWord.toLowerCase();
                        const firstPageUnique = (firstPage.match(new RegExp('\\b' + uniqueLower.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\b', 'gi')) || []).length;
                        const allUnique = (lowerText.match(new RegExp('\\b' + uniqueLower.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\b', 'gi')) || []).length;
                        score += firstPageUnique * 10 * config.weight + allUnique * 3 * config.weight;
                    });
                }
                
                if (score > 0) {
                    scores[country] = score;
                }
            });
            
            if (Object.keys(scores).length === 0) return null;
            
            // 获取最高分的国家
            const sortedCountries = Object.entries(scores)
                .sort((a, b) => b[1] - a[1]);
            
            // 如果最高分明显高于第二名（>30%），则返回最高分国家
            if (sortedCountries.length === 1 || 
                sortedCountries[0][1] > sortedCountries[1][1] * 1.3) {
                return sortedCountries[0][0];
            }
            
            // 否则返回Unknown
            console.log('国家识别得分:', sortedCountries.slice(0, 3));
            return sortedCountries[0][0];
        }

        // 清洗文本
        function cleanText(text) {
            let cleaned = text;
            
            if (document.getElementById('removeUrls').checked) {
                cleaned = cleaned.replace(/https?:\/\/[^\s]+/g, '');
            }
            if (document.getElementById('removePageNumbers').checked) {
                cleaned = cleaned.replace(/^\s*\d+\s*$/gm, '');
                cleaned = cleaned.replace(/Page \d+ of \d+/gi, '');
            }
            if (document.getElementById('normalizeWhitespace').checked) {
                cleaned = cleaned.replace(/\s+/g, ' ');
                cleaned = cleaned.replace(/\n\s*\n/g, '\n\n');
            }
            
            return cleaned.trim();
        }

        // 提取PDF文本
        async function extractTextFromPDF(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await window.pdfjsLib.getDocument(arrayBuffer).promise;
            let fullText = '';
            
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                const pageText = textContent.items.map(item => item.str).join(' ');
                fullText += pageText + '\n\n';
            }
            
            return fullText;
        }

        // 处理PDF
        document.getElementById('processBtn').addEventListener('click', async () => {
            if (selectedFiles.length === 0) {
                alert('请先选择PDF文件');
                return;
            }

            const statusDiv = document.getElementById('status');
            const statusText = document.getElementById('statusText');
            const processBtn = document.getElementById('processBtn');
            
            statusDiv.classList.remove('hidden');
            statusDiv.className = 'mb-4 p-3 rounded-lg bg-blue-50 text-blue-700';
            processBtn.disabled = true;
            
            processedResults = []; // 确保清空旧结果
            const trackingData = [];

            for (let i = 0; i < selectedFiles.length; i++) {
                const file = selectedFiles[i];
                statusText.textContent = `处理中 ${i + 1}/${selectedFiles.length}: ${file.name}`;
                
                try {
                    const rawText = await extractTextFromPDF(file);
                    const cleanedText = cleanText(rawText);
                    
                    const year = document.getElementById('detectYear').checked ? extractYear(rawText) : null;
                    const country = document.getElementById('detectCountry').checked ? extractCountry(rawText) : null;
                    
                    const wordCount = cleanedText.split(/\s+/).filter(w => w.length > 0).length;
                    const preview = cleanedText.substring(0, 200).replace(/\s+/g, ' ').trim() + '...';
                    
                    const originalName = file.name.replace('.pdf', '');
                    const newFileName = [
                        country,
                        year,
                        originalName
                    ].filter(v => v !== null && v !== undefined).join('_') + '.txt';
                    
                    const result = {
                        originalFilename: file.name,
                        newFilename: newFileName,
                        year: year || '未识别',
                        country: country || '未识别',
                        cleanedText,
                        wordCount,
                        charCount: cleanedText.length,
                        lineCount: cleanedText.split('\n').length,
                        preview,
                        status: 'success'
                    };
                    
                    processedResults.push(result);
                    console.log(`成功处理第 ${i + 1} 个文件:`, result.originalFilename);
                    
                    trackingData.push({
                        '序号': i + 1,
                        '原文件名': file.name,
                        '新文件名': newFileName,
                        '识别年份': year || '未识别',
                        '识别国家': country || '未识别',
                        '字数': wordCount,
                        '字符数': cleanedText.length,
                        '行数': cleanedText.split('\n').length,
                        '内容预览': preview,
                        '处理时间': new Date().toLocaleString('zh-CN'),
                        '状态': '成功'
                    });
                    
                } catch (error) {
                    console.error(`处理文件失败 ${file.name}:`, error);
                    processedResults.push({
                        originalFilename: file.name,
                        error: error.message,
                        status: 'error'
                    });
                    
                    trackingData.push({
                        '序号': i + 1,
                        '原文件名': file.name,
                        '新文件名': '处理失败',
                        '识别年份': '-',
                        '识别国家': '-',
                        '字数': 0,
                        '字符数': 0,
                        '行数': 0,
                        '内容预览': '错误: ' + error.message,
                        '处理时间': new Date().toLocaleString('zh-CN'),
                        '状态': '失败'
                    });
                }
            }

            console.log('所有处理结果:', processedResults);
            
            // 保存追踪数据供下载使用
            window.trackingData = trackingData;
            
            statusDiv.className = 'mb-4 p-3 rounded-lg bg-green-50 text-green-700';
            statusText.textContent = `✅ 处理完成！共处理 ${processedResults.length} 个文件，成功 ${processedResults.filter(r => r.status === 'success').length} 个`;
            processBtn.disabled = false;
            
            displayResults();
        });

        // 显示结果
        function displayResults() {
            const resultsList = document.getElementById('resultsList');
            const resultCount = document.getElementById('resultCount');
            resultsList.innerHTML = '';
            resultCount.textContent = processedResults.length;
            
            console.log('显示结果数量:', processedResults.length);
            
            processedResults.forEach((result, idx) => {
                const div = document.createElement('div');
                div.className = 'border border-gray-200 rounded-lg p-4 bg-white shadow-sm';
                
                if (result.status === 'success') {
                    div.innerHTML = `
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <span class="text-sm text-gray-500">文件 #${idx + 1}</span>
                                </div>
                                <div class="text-sm text-gray-500 mb-1">原文件名:</div>
                                <div class="font-medium text-gray-800 mb-2">${result.originalFilename}</div>
                                <div class="text-sm text-gray-500 mb-1">新文件名:</div>
                                <div class="font-semibold text-indigo-700 mb-2">${result.newFilename}</div>
                                <div class="flex gap-4 text-sm text-gray-600 flex-wrap">
                                    <span class="bg-blue-100 px-2 py-1 rounded">📅 ${result.year}</span>
                                    <span class="bg-green-100 px-2 py-1 rounded">🌍 ${result.country}</span>
                                    <span class="bg-purple-100 px-2 py-1 rounded">📝 ${result.wordCount} 词</span>
                                    <span class="bg-gray-100 px-2 py-1 rounded">💾 ${result.charCount} 字符</span>
                                </div>
                            </div>
                            <button onclick="downloadSingleTXT(${idx})" class="px-3 py-1 bg-indigo-600 text-white rounded text-sm hover:bg-indigo-700 transition whitespace-nowrap ml-4">
                                下载TXT
                            </button>
                        </div>
                        <div class="bg-gray-50 rounded p-3 mt-3">
                            <div class="text-xs text-gray-600 mb-1">内容预览:</div>
                            <pre class="text-xs text-gray-700 whitespace-pre-wrap">${result.preview}</pre>
                        </div>
                    `;
                } else {
                    div.innerHTML = `
                        <div class="flex items-start gap-3">
                            <svg class="w-5 h-5 text-red-500 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <div>
                                <div class="text-sm text-gray-500 mb-1">文件 #${idx + 1}</div>
                                <div class="font-medium text-gray-800 mb-1">${result.originalFilename}</div>
                                <div class="text-red-600 text-sm">❌ 错误: ${result.error}</div>
                            </div>
                        </div>
                    `;
                }
                
                resultsList.appendChild(div);
            });
            
            document.getElementById('results').classList.remove('hidden');
        }

        // 下载单个TXT
        window.downloadSingleTXT = function(idx) {
            const result = processedResults[idx];
            if (!result || result.status !== 'success') {
                alert('无法下载该文件');
                return;
            }
            const blob = new Blob([result.cleanedText], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = result.newFilename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            console.log('下载文件:', result.newFilename);
        };

        // 下载全部TXT
        document.getElementById('downloadAllTxt').addEventListener('click', () => {
            const successResults = processedResults.filter(r => r.status === 'success');
            console.log('准备下载', successResults.length, '个TXT文件');
            
            if (successResults.length === 0) {
                alert('没有可下载的文件');
                return;
            }
            
            successResults.forEach((result, idx) => {
                setTimeout(() => {
                    const blob = new Blob([result.cleanedText], { type: 'text/plain;charset=utf-8' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = result.newFilename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    console.log('下载第', idx + 1, '个文件:', result.newFilename);
                }, idx * 200); // 延迟下载，避免浏览器阻止
            });
        });

        // 下载BERTopic格式
        document.getElementById('downloadBertopic').addEventListener('click', () => {
            const successResults = processedResults.filter(r => r.status === 'success');
            
            if (successResults.length === 0) {
                alert('没有可下载的文件');
                return;
            }
            
            const text = successResults
                .map(r => r.cleanedText.replace(/\n/g, ' ').replace(/\s+/g, ' ').trim())
                .join('\n');
            
            const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `bertopic_corpus_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            console.log('BERTopic格式下载完成');
        });

        // 下载Excel
        document.getElementById('downloadExcel').addEventListener('click', () => {
            if (!window.trackingData || window.trackingData.length === 0) {
                alert('没有可下载的数据');
                return;
            }
            
            const ws = XLSX.utils.json_to_sheet(window.trackingData);
            ws['!cols'] = [
                { wch: 6 }, { wch: 35 }, { wch: 40 }, { wch: 10 }, { wch: 12 },
                { wch: 8 }, { wch: 10 }, { wch: 8 }, { wch: 50 }, { wch: 18 }, { wch: 8 }
            ];
            
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'PDF处理追踪');
            
            const instructionsData = [
                { '说明': '本表格记录PDF文件的处理信息' },
                { '说明': '可用于持续追踪和管理文档处理进度' },
                { '说明': '每次处理会生成新的记录' },
                { '说明': '识别年份范围: 1990-2025' },
                { '说明': '支持国家: 30+主要国家和地区' }
            ];
            const wsInstructions = XLSX.utils.json_to_sheet(instructionsData);
            XLSX.utils.book_append_sheet(wb, wsInstructions, '使用说明');
            
            XLSX.writeFile(wb, `PDF处理追踪表_${new Date().toISOString().split('T')[0]}.xlsx`);
            console.log('Excel追踪表下载完成');
        });
    </script>
</body>
</html>